<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Food Management | Admin — Bite Box</title>
<style>
 body{font-family:Inter,Arial;background:#f3f7f6;margin:0;color:#0b2f2c}
 header{background:#10332f;color:#fff;padding:12px 18px}
 main{max-width:1100px;margin:18px auto;padding:12px}
 .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
 .card{background:#fff;padding:12px;border-radius:10px}
 label{display:block;font-size:13px;margin-top:8px}
 input,select,textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd}
 button{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
 .danger{background:#ff6b6b;color:#fff}
 .primary{background:#27ae60;color:#fff}
 .food-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
 .food-card{background:#fff;padding:10px;border-radius:8px;display:flex;gap:10px;align-items:center}
 .food-card img{width:64px;height:64px;border-radius:10px;object-fit:cover}
 .actions{display:flex;gap:8px}
 .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
 .modal .inner{background:#fff;padding:16px;border-radius:10px;width:400px}
</style>
</head>
<body>
<header><strong>Food Items</strong> — Add / Edit / Delete</header>
<main>
  <div class="grid">
    <div class="card">
      <h3>List</h3>
      <div id="listWrap">Loading…</div>
    </div>

    <div class="card">
      <h3>Add New Item</h3>
      <label>Name <input id="fName"/></label>
      <label>Description <textarea id="fDesc"></textarea></label>
      <label>Price <input id="fPrice" type="number"/></label>
      <label>Category <select id="fCategory"><option value="veg">Veg</option><option value="nonveg">Non-Veg</option></select></label>
      <label>Image URL or filename <input id="fImage"/></label>
      <button id="addBtn" class="primary">Add Item</button>
    </div>
  </div>
</main>

<!-- Edit Modal -->
<div id="editModal" style="display:none" class="modal">
  <div class="inner">
    <h3>Edit item</h3>
    <label>Name <input id="eName"/></label>
    <label>Description <textarea id="eDesc"></textarea></label>
    <label>Price <input id="ePrice" type="number"/></label>
    <label>Category <select id="eCategory"><option value="veg">Veg</option><option value="nonveg">Non-Veg</option></select></label>
    <label>Image URL <input id="eImage"/></label>
    <div style="margin-top:10px">
      <button id="saveEdit" class="primary">Save</button>
      <button id="cancelEdit" class="danger">Cancel</button>
    </div>
  </div>
</div>

<script>
const BASE_URL = localStorage.getItem('BB_BACKEND') || 'https://bbbackend-bng2.onrender.com';
const token = localStorage.getItem('adminToken');
if(!token) location.href='admin-login.html';

const listWrap = document.getElementById('listWrap');

async function loadItems(){
  try{
    const res = await fetch(`${BASE_URL}/api/food`, { headers: { Authorization: 'Bearer '+token }});
    const items = await res.json();
    renderList(items);
  }catch(e){
    console.error(e);
    listWrap.textContent = 'Failed to load';
  }
}

function renderList(items){
  if(!Array.isArray(items)) { listWrap.textContent = 'No items'; return; }
  listWrap.innerHTML = '<div class="food-list">'+items.map(it=>`
    <div class="food-card" data-id="${it._id}">
      <img src="${it.image||'../images/default-food.jpg'}"/>
      <div style="flex:1">
        <div style="font-weight:700">${it.name}</div>
        <div style="font-size:13px;color:#666">${(it.description||'')}</div>
        <div style="margin-top:6px;font-weight:600">₹${it.price||0}</div>
      </div>
      <div class="actions">
        <button onclick="onEdit('${it._id}')" style="padding:6px 8px">Edit</button>
        <button onclick="onDelete('${it._id}')" class="danger">Delete</button>
      </div>
    </div>`).join('')+'</div>';
}

document.getElementById('addBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('fName').value.trim();
  const description = document.getElementById('fDesc').value.trim();
  const price = Number(document.getElementById('fPrice').value || 0);
  const category = document.getElementById('fCategory').value;
  const imageUrl = document.getElementById('fImage').value.trim();

  if(!name || price<=0){ alert('Provide name and price'); return; }
  try {
    const res = await fetch(`${BASE_URL}/api/food/add`, {
      method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body: JSON.stringify({ name, description, price, category, image: imageUrl })
    });
    if(!res.ok) throw new Error('Add failed');
    alert('Added');
    document.getElementById('fName').value=''; document.getElementById('fDesc').value=''; document.getElementById('fPrice').value='';
    loadItems();
  } catch(e){ alert(e.message||'Error'); }
});

let editingId = null;
window.onEdit = async function(id){
  try {
    const res = await fetch(`${BASE_URL}/api/food`, {headers:{Authorization:'Bearer '+token}});
    const items = await res.json();
    const it = items.find(x=>x._id===id);
    if(!it) return alert('Not found');
    editingId = id;
    document.getElementById('eName').value = it.name || '';
    document.getElementById('eDesc').value = it.description || '';
    document.getElementById('ePrice').value = it.price || 0;
    document.getElementById('eCategory').value = it.category || 'veg';
    document.getElementById('eImage').value = it.image || '';
    document.getElementById('editModal').style.display='flex';
  } catch(e){ console.error(e); alert('Error'); }
};

document.getElementById('cancelEdit').addEventListener('click', ()=> { document.getElementById('editModal').style.display='none'; editingId=null; });

document.getElementById('saveEdit').addEventListener('click', async ()=>{
  if(!editingId) return;
  const payload = {
    name: document.getElementById('eName').value.trim(),
    description: document.getElementById('eDesc').value.trim(),
    price: Number(document.getElementById('ePrice').value||0),
    category: document.getElementById('eCategory').value,
    image: document.getElementById('eImage').value.trim()
  };
  try {
    const res = await fetch(`${BASE_URL}/api/food/edit/${editingId}`, {
      method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Update failed');
    alert('Updated');
    document.getElementById('editModal').style.display='none';
    editingId=null; loadItems();
  } catch(e){ alert(e.message||'Failed'); }
});

window.onDelete = async function(id){
  if(!confirm('Delete item?')) return;
  try {
    const res = await fetch(`${BASE_URL}/api/food/delete/${id}`, { method:'DELETE', headers:{Authorization:'Bearer '+token}});
    if(!res.ok) throw new Error('Delete failed');
    alert('Deleted'); loadItems();
  } catch(e){ alert('Delete failed'); console.error(e); }
};

loadItems();
</script>
</body>
</html>
